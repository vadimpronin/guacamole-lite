<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>guacamole-lite Admin Dashboard - Session Join Tracking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #4285f4;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }

    .sessions-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .sessions-header {
      background: #4285f4;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .refresh-btn {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .refresh-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .sessions-content {
      padding: 20px;
    }

    .session-card {
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      margin-bottom: 15px;
      overflow: hidden;
    }

    .session-header {
      background: #f8f9fa;
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
    }

    .session-id {
      font-weight: bold;
      color: #333;
      font-family: monospace;
    }

    .session-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-size: 0.8em;
      color: #666;
      text-transform: uppercase;
    }

    .info-value {
      font-weight: 500;
      color: #333;
    }

    .joins-section {
      padding: 15px;
    }

    .joins-header {
      font-weight: bold;
      color: #555;
      margin-bottom: 10px;
    }

    .join-item {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
    }

    .join-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      font-size: 0.9em;
    }

    .no-sessions {
      text-align: center;
      color: #666;
      padding: 40px;
      font-style: italic;
    }

    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .timestamp {
      font-size: 0.8em;
      color: #999;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>guacamole-lite - Session Dashboard</h1>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="total-sessions">-</div>
        <div class="stat-label">Active Sessions</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="total-joins">-</div>
        <div class="stat-label">Total Joins</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="guacd-instances">3</div>
        <div class="stat-label">guacd Instances</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="server-status">-</div>
        <div class="stat-label">Server Status</div>
      </div>
    </div>

    <div class="sessions-container">
      <div class="sessions-header">
        <h2>Active Sessions with Join Tracking</h2>
        <button class="refresh-btn" onclick="loadSessions()">Refresh</button>
      </div>
      <div class="sessions-content">
        <div id="loading" class="loading">Loading session data...</div>
        <div id="error" class="error-message" style="display: none;"></div>
        <div id="sessions-list"></div>
        <div id="timestamp" class="timestamp"></div>
      </div>
    </div>
  </div>

  <script>
    async function loadSessions() {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      const sessionsEl = document.getElementById('sessions-list');
      const timestampEl = document.getElementById('timestamp');

      loadingEl.style.display = 'block';
      errorEl.style.display = 'none';
      sessionsEl.innerHTML = '';

      try {
        const response = await fetch('/api/sessions');
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        loadingEl.style.display = 'none';

        // Update stats
        document.getElementById('total-sessions').textContent = data.totalSessions || 0;

        let totalJoins = 0;
        Object.values(data.sessions || {}).forEach(session => {
          totalJoins += (session.joinedConnections || []).length;
        });
        document.getElementById('total-joins').textContent = totalJoins;

        // Check server health
        try {
          const healthResponse = await fetch('/api/health');
          const healthData = await healthResponse.json();
          document.getElementById('server-status').textContent = healthData.status || 'Unknown';
        } catch {
          document.getElementById('server-status').textContent = 'Error';
        }

        if (data.totalSessions === 0) {
          sessionsEl.innerHTML = '<div class="no-sessions">No active sessions. Start a connection from the client to see session tracking in action.</div>';
        } else {
          renderSessions(data.sessions);
        }

        timestampEl.textContent = `Last updated: ${new Date().toLocaleString()}`;

      } catch (error) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `Failed to load session data: ${error.message}`;
        console.error('Error loading sessions:', error);
      }
    }

    function renderSessions(sessions) {
      const sessionsEl = document.getElementById('sessions-list');

      Object.entries(sessions).forEach(([sessionId, session]) => {
        const sessionCard = document.createElement('div');
        sessionCard.className = 'session-card';

        const joinCount = (session.joinedConnections || []).length;
        const createdAt = new Date(session.createdAt).toLocaleString();

        sessionCard.innerHTML = `
                    <div class="session-header">
                        <div class="session-id">Session ID: ${sessionId}</div>
                        <div class="session-info">
                            <div class="info-item">
                                <span class="info-label">guacd Instance</span>
                                <span class="info-value">${session.guacdHost}:${session.guacdPort}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Protocol</span>
                                <span class="info-value">${(session.connectionInfo?.type || 'Unknown').toUpperCase()}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Created</span>
                                <span class="info-value">${createdAt}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Joined Connections</span>
                                <span class="info-value">${joinCount}</span>
                            </div>
                        </div>
                    </div>
                    ${joinCount > 0 ? renderJoins(session.joinedConnections) : ''}
                `;

        sessionsEl.appendChild(sessionCard);
      });
    }

    function renderJoins(joinedConnections) {
      if (!joinedConnections || joinedConnections.length === 0) {
        return '';
      }

      const joinsHtml = joinedConnections.map(join => {
        const joinedAt = new Date(join.joinedAt).toLocaleString();
        const readOnly = join.joinSettings?.['read-only'] ? 'Yes' : 'No';

        return `
                    <div class="join-item">
                        <div class="join-info">
                            <div class="info-item">
                                <span class="info-label">Connection ID</span>
                                <span class="info-value">${join.connectionId}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Guacamole ID</span>
                                <span class="info-value">${join.guacamoleConnectionId}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Joined At</span>
                                <span class="info-value">${joinedAt}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Read-Only</span>
                                <span class="info-value">${readOnly}</span>
                            </div>
                        </div>
                    </div>
                `;
      }).join('');

      return `
                <div class="joins-section">
                    <div class="joins-header">Joined Connections (${joinedConnections.length})</div>
                    ${joinsHtml}
                </div>
            `;
    }

    // Load sessions on page load
    loadSessions();

    // Auto-refresh every 5 seconds
    setInterval(loadSessions, 5000);
  </script>
</body>

</html>
